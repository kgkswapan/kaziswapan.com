---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Main from "@/layouts/Main.astro";

type GoodreadsBook = {
  title: string;
  author: string;
  link: string;
  image: string;
  dateRead?: string;
  dateReadLabel?: string;
};

const GOODREADS_USER_ID = "55613653";
const BOOKS_PER_PAGE = 12;

const stripCdata = (value: string) =>
  value.replace(/<!\[CDATA\[([\s\S]*?)\]\]>/, "$1").trim();

const extractTag = (item: string, tag: string) => {
  const match = item.match(new RegExp(`<${tag}>([\\s\\S]*?)</${tag}>`));
  return match ? stripCdata(match[1]) : "";
};

const parseGoodreadsRss = (xml: string): GoodreadsBook[] => {
  const items = xml.match(/<item>[\s\S]*?<\/item>/g) ?? [];
  return items.reduce<GoodreadsBook[]>((acc, item) => {
    const title = extractTag(item, "title");
    const author = extractTag(item, "author_name");
    const link = extractTag(item, "link");
    const image =
      extractTag(item, "book_medium_image_url") ||
      extractTag(item, "book_image_url");
    const dateRead = extractTag(item, "user_read_at");
    const dateReadLabel = dateRead
      ? new Date(dateRead).toLocaleDateString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
        })
      : undefined;

    if (!title || !author) return acc;

    acc.push({
      title,
      author,
      link,
      image,
      dateRead: dateRead || undefined,
      dateReadLabel,
    });
    return acc;
  }, []);
};

const fetchShelf = async (shelf: string): Promise<GoodreadsBook[]> => {
  try {
    const url = new URL(
      `https://www.goodreads.com/review/list_rss/${GOODREADS_USER_ID}`
    );
    url.searchParams.set("shelf", shelf);
    if (shelf === "read") {
      url.searchParams.set("sort", "date_read");
      url.searchParams.set("order", "d");
    }

    const response = await fetch(url, {
      headers: {
        "User-Agent": "KaziGulamKadarSite/1.0",
      },
    });
    if (!response.ok) return [];
    const xml = await response.text();
    return parseGoodreadsRss(xml);
  } catch {
    return [];
  }
};

const [currentReading, readShelf] = await Promise.all([
  fetchShelf("currently-reading"),
  fetchShelf("read"),
]);

const sortedReadShelf = [...readShelf].sort((a, b) => {
  const dateA = a.dateRead ? new Date(a.dateRead).getTime() : 0;
  const dateB = b.dateRead ? new Date(b.dateRead).getTime() : 0;
  return dateB - dateA;
});

const initialRead = sortedReadShelf.slice(0, BOOKS_PER_PAGE);
const readPayload = JSON.stringify(sortedReadShelf).replace(/</g, "\\u003c");
---

<Layout>
  <Header />
  <Main
    pageTitle="Books I am reading"
    pageDesc="Currently reading and recently finished titles from my Goodreads shelf."
  >
    <section class="section-unstyled px-0">
      <h2 class="text-2xl font-semibold text-foreground">Currently reading</h2>
      <div class="mt-6 grid gap-6 md:grid-cols-2">
        {
          currentReading.length > 0 ? (
            currentReading.map(book => (
              <article class="flex flex-col gap-4 rounded-2xl border border-border/70 bg-background/80 p-6 shadow-sm sm:flex-row">
                <div class="w-full max-w-[96px] overflow-hidden rounded-xl bg-slate-100 shadow-sm dark:bg-slate-800">
                  {book.image ? (
                    <img
                      src={book.image}
                      alt={`Cover of ${book.title}`}
                      class="h-36 w-full object-cover"
                      loading="lazy"
                    />
                  ) : (
                    <div class="flex h-36 items-center justify-center text-xs text-muted">
                      No cover
                    </div>
                  )}
                </div>
                <div class="flex flex-1 flex-col justify-center gap-2">
                  <span class="text-xs font-semibold tracking-[0.2em] text-accent uppercase">
                    Currently reading
                  </span>
                  <h3 class="text-lg font-semibold text-foreground">
                    {book.link ? (
                      <a href={book.link} target="_blank" rel="noreferrer">
                        {book.title}
                      </a>
                    ) : (
                      book.title
                    )}
                  </h3>
                  <p class="text-sm text-foreground/80">{book.author}</p>
                </div>
              </article>
            ))
          ) : (
            <p class="text-sm text-muted">No books on this shelf yet.</p>
          )
        }
      </div>
    </section>

    <section class="section-unstyled mt-12 px-0">
      <div
        class="flex flex-col gap-2 sm:flex-row sm:items-baseline sm:justify-between"
      >
        <h2 class="text-2xl font-semibold text-foreground">Recent reads</h2>
        <p class="text-sm text-muted">From the Goodreads read shelf.</p>
      </div>
      <div
        class="mt-6 grid gap-6 md:grid-cols-2"
        data-read-grid
        data-offset={initialRead.length}
      >
        {
          initialRead.length > 0 ? (
            initialRead.map(book => (
              <article class="flex flex-col gap-4 rounded-2xl border border-border/70 bg-background/80 p-6 shadow-sm sm:flex-row">
                <div class="w-full max-w-[96px] overflow-hidden rounded-xl bg-slate-100 shadow-sm dark:bg-slate-800">
                  {book.image ? (
                    <img
                      src={book.image}
                      alt={`Cover of ${book.title}`}
                      class="h-36 w-full object-cover"
                      loading="lazy"
                    />
                  ) : (
                    <div class="flex h-36 items-center justify-center text-xs text-muted">
                      No cover
                    </div>
                  )}
                </div>
                <div class="flex flex-1 flex-col justify-center gap-2">
                  <span class="text-xs font-semibold tracking-[0.2em] text-accent uppercase">
                    Read
                  </span>
                  <h3 class="text-lg font-semibold text-foreground">
                    {book.link ? (
                      <a href={book.link} target="_blank" rel="noreferrer">
                        {book.title}
                      </a>
                    ) : (
                      book.title
                    )}
                  </h3>
                  <p class="text-sm text-foreground/80">{book.author}</p>
                  {book.dateReadLabel && (
                    <p class="text-xs text-muted">
                      Finished {book.dateReadLabel}
                    </p>
                  )}
                </div>
              </article>
            ))
          ) : (
            <p class="text-sm text-muted">No books on this shelf yet.</p>
          )
        }
      </div>
      <div class="mt-8 flex flex-col items-center gap-4">
        <button
          class="rounded-full border border-accent/60 px-6 py-2 text-sm font-semibold text-accent transition hover:-translate-y-0.5 hover:border-accent"
          type="button"
          data-read-more
        >
          Load more
        </button>
        <p class="hidden text-sm text-muted" data-read-end>
          You have reached the end of the shelf.
        </p>
        <div class="h-1 w-full" data-read-sentinel aria-hidden="true"></div>
      </div>
      <script
        type="application/json"
        id="read-books-data"
        is:inline
        set:html={readPayload}
      />
      <script is:inline>
        const grid = document.querySelector("[data-read-grid]");
        const dataEl = document.querySelector("#read-books-data");
        const loadMoreBtn = document.querySelector("[data-read-more]");
        const endLabel = document.querySelector("[data-read-end]");
        const sentinel = document.querySelector("[data-read-sentinel]");

        if (grid && dataEl && loadMoreBtn && endLabel && sentinel) {
          const allBooks = JSON.parse(dataEl.textContent || "[]");
          const pageSize = { BOOKS_PER_PAGE };
          let offset = Number(grid.getAttribute("data-offset")) || 0;

          const createCard = book => {
            const card = document.createElement("article");
            card.className =
              "flex flex-col gap-4 rounded-2xl border border-border/70 bg-background/80 p-6 shadow-sm sm:flex-row";

            const coverWrap = document.createElement("div");
            coverWrap.className =
              "w-full max-w-[96px] overflow-hidden rounded-xl bg-slate-100 shadow-sm dark:bg-slate-800";

            if (book.image) {
              const img = document.createElement("img");
              img.src = book.image;
              img.alt = `Cover of ${book.title}`;
              img.loading = "lazy";
              img.className = "h-36 w-full object-cover";
              coverWrap.appendChild(img);
            } else {
              const placeholder = document.createElement("div");
              placeholder.className =
                "flex h-36 items-center justify-center text-xs text-muted";
              placeholder.textContent = "No cover";
              coverWrap.appendChild(placeholder);
            }

            const body = document.createElement("div");
            body.className = "flex flex-1 flex-col justify-center gap-2";

            const label = document.createElement("span");
            label.className =
              "text-xs font-semibold uppercase tracking-[0.2em] text-accent";
            label.textContent = "Read";

            const title = document.createElement("h3");
            title.className = "text-lg font-semibold text-foreground";

            if (book.link) {
              const link = document.createElement("a");
              link.href = book.link;
              link.target = "_blank";
              link.rel = "noreferrer";
              link.textContent = book.title;
              title.appendChild(link);
            } else {
              title.textContent = book.title;
            }

            const author = document.createElement("p");
            author.className = "text-sm text-foreground/80";
            author.textContent = book.author;

            body.appendChild(label);
            body.appendChild(title);
            body.appendChild(author);

            if (book.dateReadLabel) {
              const dateLine = document.createElement("p");
              dateLine.className = "text-xs text-muted";
              dateLine.textContent = `Finished ${book.dateReadLabel}`;
              body.appendChild(dateLine);
            }

            card.appendChild(coverWrap);
            card.appendChild(body);
            return card;
          };

          const appendBooks = () => {
            const next = allBooks.slice(offset, offset + pageSize);
            next.forEach(book => grid.appendChild(createCard(book)));
            offset += next.length;
            grid.setAttribute("data-offset", String(offset));

            if (offset >= allBooks.length) {
              loadMoreBtn.classList.add("hidden");
              endLabel.classList.remove("hidden");
            }
          };

          const handleLoadMore = () => {
            appendBooks();
          };

          loadMoreBtn.addEventListener("click", handleLoadMore);

          if ("IntersectionObserver" in window) {
            const observer = new IntersectionObserver(entries => {
              if (entries.some(entry => entry.isIntersecting)) {
                if (offset < allBooks.length) {
                  appendBooks();
                }
              }
            });
            observer.observe(sentinel);
          }

          if (offset >= allBooks.length) {
            loadMoreBtn.classList.add("hidden");
            endLabel.classList.remove("hidden");
          }
        }
      </script>
    </section>
  </Main>
  <Footer />
</Layout>
