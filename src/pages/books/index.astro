---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Main from "@/layouts/Main.astro";
import { getBooksData } from "@/utils/books";
import RatingStars from "@/components/RatingStars.astro";

const BOOKS_PER_PAGE = 12;

const { currentReading, read } = await getBooksData();

const initialRead = read.slice(0, BOOKS_PER_PAGE);
const readPayload = JSON.stringify(
  read.map(book => ({
    title: book.title,
    author: book.author,
    image: book.image,
    slug: book.slug,
    dateReadLabel: book.dateReadLabel,
    averageRating: book.averageRating,
  }))
).replace(/</g, "\\u003c");
---

<Layout>
  <Header />
  <Main
    pageTitle="Books I am reading"
    pageDesc="Currently reading and recently finished titles from my Goodreads shelf."
  >
    <section class="section-unstyled px-0">
      <h2 class="text-2xl font-semibold text-foreground">Currently reading</h2>
      <div class="mt-6 grid gap-6 md:grid-cols-2">
        {
          currentReading.length > 0 ? (
            currentReading.map(book => (
              <article class="flex flex-col gap-4 rounded-2xl border border-border/70 bg-background/80 p-6 shadow-sm sm:flex-row sm:items-center">
                <div class="w-full max-w-[96px] overflow-hidden rounded-xl border border-border/60">
                  {book.image ? (
                    <a href={`/books/${book.slug}/`} class="block">
                      <img
                        src={book.image}
                        alt={`Cover of ${book.title}`}
                        class="h-36 w-full object-cover"
                        loading="lazy"
                      />
                    </a>
                  ) : (
                    <div class="flex h-36 items-center justify-center text-xs text-muted">
                      No cover
                    </div>
                  )}
                </div>
                <div class="flex flex-1 flex-col justify-center gap-2">
                  <h3 class="text-lg font-semibold text-foreground">
                    <a href={`/books/${book.slug}/`}>{book.title}</a>
                  </h3>
                  <p class="text-sm text-foreground/80">{book.author}</p>
                  {typeof book.averageRating === "number" && (
                    <RatingStars rating={book.averageRating} class="text-xs" />
                  )}
                </div>
              </article>
            ))
          ) : (
            <p class="text-sm text-muted">No books on this shelf yet.</p>
          )
        }
      </div>
    </section>

    <section class="section-unstyled mt-12 px-0">
      <div>
        <h2 class="text-2xl font-semibold text-foreground">Recent reads</h2>
      </div>
      <div
        class="mt-6 grid gap-6 md:grid-cols-2"
        data-read-grid
        data-offset={initialRead.length}
        data-page-size={BOOKS_PER_PAGE}
      >
        {
          initialRead.length > 0 ? (
            initialRead.map(book => (
              <article class="flex flex-col gap-4 rounded-2xl border border-border/70 bg-background/80 p-6 shadow-sm sm:flex-row sm:items-center">
                <div class="w-full max-w-[96px] overflow-hidden rounded-xl border border-border/60">
                  {book.image ? (
                    <a href={`/books/${book.slug}/`} class="block">
                      <img
                        src={book.image}
                        alt={`Cover of ${book.title}`}
                        class="h-36 w-full object-cover"
                        loading="lazy"
                      />
                    </a>
                  ) : (
                    <div class="flex h-36 items-center justify-center text-xs text-muted">
                      No cover
                    </div>
                  )}
                </div>
                <div class="flex flex-1 flex-col justify-center gap-2">
                  <h3 class="text-lg font-semibold text-foreground">
                    <a href={`/books/${book.slug}/`}>{book.title}</a>
                  </h3>
                  <p class="text-sm text-foreground/80">{book.author}</p>
                  {typeof book.averageRating === "number" && (
                    <RatingStars rating={book.averageRating} class="text-xs" />
                  )}
                  {book.dateReadLabel && (
                    <p class="text-xs text-foreground/70 italic">
                      Finished {book.dateReadLabel}
                    </p>
                  )}
                </div>
              </article>
            ))
          ) : (
            <p class="text-sm text-muted">No books on this shelf yet.</p>
          )
        }
      </div>
      <div class="mt-8 flex flex-col items-center gap-4">
        <button
          class="rounded-full border border-accent/60 px-6 py-2 text-sm font-semibold text-accent transition hover:-translate-y-0.5 hover:border-accent"
          type="button"
          data-read-more
        >
          Load more
        </button>
        <p class="hidden text-sm text-muted" data-read-end>
          You have reached the end of the shelf.
        </p>
        <div class="h-1 w-full" data-read-sentinel aria-hidden="true"></div>
      </div>
      <script
        type="application/json"
        id="read-books-data"
        is:inline
        set:html={readPayload}
      />
      <script is:inline>
        const initReadShelf = () => {
          const grid = document.querySelector("[data-read-grid]");
          const dataEl = document.querySelector("#read-books-data");
          const loadMoreBtn = document.querySelector("[data-read-more]");
          const endLabel = document.querySelector("[data-read-end]");
          const sentinel = document.querySelector("[data-read-sentinel]");

          if (!grid || !dataEl || !loadMoreBtn || !endLabel || !sentinel) {
            return;
          }

          if (grid.dataset.infiniteReady === "true") {
            return;
          }
          grid.dataset.infiniteReady = "true";

          const allBooks = JSON.parse(dataEl.textContent || "[]");
          const pageSize = Number(grid.getAttribute("data-page-size")) || 12;
          let offset = Number(grid.getAttribute("data-offset")) || 0;

          const createCard = book => {
            const card = document.createElement("article");
            card.className =
              "flex flex-col gap-4 rounded-2xl border border-border/70 bg-background/80 p-6 shadow-sm sm:flex-row sm:items-center";

            const coverWrap = document.createElement("div");
            coverWrap.className =
              "w-full max-w-[96px] overflow-hidden rounded-xl border border-border/60";

            if (book.image) {
              const link = document.createElement("a");
              link.href = `/books/${book.slug}/`;
              link.className = "block";

              const img = document.createElement("img");
              img.src = book.image;
              img.alt = `Cover of ${book.title}`;
              img.loading = "lazy";
              img.className = "h-36 w-full object-cover";
              link.appendChild(img);
              coverWrap.appendChild(link);
            } else {
              const placeholder = document.createElement("div");
              placeholder.className =
                "flex h-36 items-center justify-center text-xs text-muted";
              placeholder.textContent = "No cover";
              coverWrap.appendChild(placeholder);
            }

            const body = document.createElement("div");
            body.className = "flex flex-1 flex-col justify-center gap-2";

            const title = document.createElement("h3");
            title.className = "text-lg font-semibold text-foreground";

            const link = document.createElement("a");
            link.href = `/books/${book.slug}/`;
            link.textContent = book.title;
            title.appendChild(link);

            const author = document.createElement("p");
            author.className = "text-sm text-foreground/80";
            author.textContent = book.author;

            body.appendChild(title);
            body.appendChild(author);

            if (typeof book.averageRating === "number") {
              const rounded = Math.round(book.averageRating * 2) / 2;
              const fullStars = Math.floor(rounded);
              const hasHalf = rounded % 1 !== 0;
              const emptyStars = 5 - fullStars - (hasHalf ? 1 : 0);
              const ratingWrap = document.createElement("div");
              ratingWrap.className = "flex items-center gap-1 text-xs";
              ratingWrap.setAttribute(
                "aria-label",
                `Rating ${book.averageRating.toFixed(2)} out of 5`
              );

              const makeIcon = className => {
                const icon = document.createElement("i");
                icon.className = className;
                icon.setAttribute("aria-hidden", "true");
                return icon;
              };

              for (let i = 0; i < fullStars; i += 1) {
                ratingWrap.appendChild(
                  makeIcon("fa-solid fa-star text-accent")
                );
              }
              if (hasHalf) {
                ratingWrap.appendChild(
                  makeIcon("fa-solid fa-star-half-stroke text-accent")
                );
              }
              for (let i = 0; i < emptyStars; i += 1) {
                ratingWrap.appendChild(
                  makeIcon("fa-regular fa-star text-muted")
                );
              }
              body.appendChild(ratingWrap);
            }

            if (book.dateReadLabel) {
              const dateLine = document.createElement("p");
              dateLine.className = "text-xs text-foreground/70 italic";
              dateLine.textContent = `Finished ${book.dateReadLabel}`;
              body.appendChild(dateLine);
            }

            card.appendChild(coverWrap);
            card.appendChild(body);
            return card;
          };

          const appendBooks = () => {
            const next = allBooks.slice(offset, offset + pageSize);
            next.forEach(book => grid.appendChild(createCard(book)));
            offset += next.length;
            grid.setAttribute("data-offset", String(offset));

            if (offset >= allBooks.length) {
              loadMoreBtn.classList.add("hidden");
              endLabel.classList.remove("hidden");
            }
          };

          const handleLoadMore = () => {
            appendBooks();
          };

          loadMoreBtn.addEventListener("click", handleLoadMore);

          if ("IntersectionObserver" in window) {
            const observer = new IntersectionObserver(entries => {
              if (entries.some(entry => entry.isIntersecting)) {
                if (offset < allBooks.length) {
                  appendBooks();
                }
              }
            });
            observer.observe(sentinel);
          }

          if (offset >= allBooks.length) {
            loadMoreBtn.classList.add("hidden");
            endLabel.classList.remove("hidden");
          }
        };

        initReadShelf();
        document.addEventListener("astro:after-swap", initReadShelf);
      </script>
    </section>
  </Main>
  <Footer />
</Layout>
