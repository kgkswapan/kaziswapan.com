---
import { render, type CollectionEntry, getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import BackButton from "@/components/BackButton.astro";
import LinkButton from "@/components/LinkButton.astro";
import NoteCard from "@/components/NoteCard.astro";
import getProjectSlug from "@/utils/getProjectSlug";
import { getCollection as getNotesCollection } from "astro:content";
import MilestoneProgress from "@/components/MilestoneProgress.astro";

interface Props {
  project: CollectionEntry<"projects">;
}

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  return projects.map(project => ({
    params: { slug: getProjectSlug(project) },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await render(project);
const { title, summary, tech, link, ssrn, noteTag } = project.data;
const embedMap = (project.data as { embedMap?: string }).embedMap;
const milestoneProgress = project.data
  .milestoneProgress as Record<string, number> | undefined;
const hasTech = typeof tech === "string" && tech.trim().length > 0;
const techList = hasTech
  ? tech
      .split(",")
      .map(item => item.trim())
      .filter(Boolean)
  : [];
const rawData = project.data as Record<string, unknown> &
  Partial<Record<`link${number}` | `buttonText${number}`, string>>;
const dynamicLinks = Object.entries(rawData)
  .filter(
    ([key, value]) =>
      /^link\d+$/.test(key) &&
      typeof value === "string" &&
      value.trim().length > 0
  )
  .map(([key, href]) => {
    const suffix = key.replace("link", "");
    const textKey = `buttonText${suffix}`;
    const buttonTextRaw = rawData[textKey];
    const text =
      typeof buttonTextRaw === "string" && buttonTextRaw.trim().length > 0
        ? buttonTextRaw
        : "View Project";
    return { href: href as string, text };
  });
const baseLink =
  typeof link === "string" && link.trim().length > 0
    ? [{ href: link, text: "View Project" }]
    : [];
const linkButtons = [
  ...baseLink,
  ...dynamicLinks,
  ...(typeof ssrn === "string" && ssrn.trim().length > 0
    ? [{ href: ssrn, text: "View on SSRN" }]
    : []),
];
const notes = noteTag
  ? (await getNotesCollection("notes")).filter(note =>
      note.data.tags
        .map(tag => tag.toLowerCase())
        .includes(noteTag.toLowerCase())
    )
  : [];
---

<Layout title={`${title} | Projects`} description={summary}>
  <Header />
  <BackButton />
  <main class="mx-auto w-full max-w-app px-4 pb-12">
    <h1 class="text-2xl font-semibold text-foreground sm:text-3xl">{title}</h1>
    <p class="mt-2 text-base italic text-foreground/80">{summary}</p>
    {milestoneProgress && (
      <MilestoneProgress milestones={milestoneProgress} />
    )}
    {techList.length > 0 && (
      <div class="mt-4 flex flex-wrap items-center gap-3 text-sm font-medium text-foreground">
        <span class="font-semibold uppercase tracking-wide text-foreground/70">
          Tech
        </span>
        <div class="flex flex-wrap gap-2">
          {techList.map(item => (
            <span class="rounded-full border border-accent/60 px-3 py-1 text-xs font-semibold text-accent">
              {item}
            </span>
          ))}
        </div>
      </div>
    )}
    {linkButtons.length > 0 && (
      <div class="mt-4 flex flex-wrap gap-3">
        {linkButtons.map(button => (
          <LinkButton
            class="rounded-full border border-accent/70 px-4 py-2 text-sm font-semibold text-accent transition hover:-translate-y-0.5 hover:border-accent"
            href={button.href}
            target="_blank"
          >
            {button.text}
          </LinkButton>
        ))}
      </div>
    )}
    <article class="app-prose mx-auto mt-8 max-w-app prose-pre:bg-(--shiki-light-bg) dark:prose-pre:bg-(--shiki-dark-bg)">
      <Content />
    </article>
    {
      embedMap && (
        <section class="mt-10">
          <div class="overflow-hidden rounded-2xl border border-muted/60 shadow-sm">
            <iframe
              title={`Map for ${title}`}
              src={embedMap}
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
              allowfullscreen
              class="h-[420px] w-full border-0 sm:h-[520px]"
            />
          </div>
        </section>
      )
    }

    {notes.length > 0 && (
      <section class="section-unstyled mt-12 px-0">
        <h2 class="text-xl font-semibold text-foreground">
          Related notes
        </h2>
        <div class="mt-6 grid gap-6 md:grid-cols-2">
          {notes.map(note => <NoteCard note={note} />)}
        </div>
      </section>
    )}
  </main>
  <Footer />
</Layout>
