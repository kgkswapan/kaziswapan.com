---
import type { GetStaticPaths } from "astro";
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Main from "@/layouts/Main.astro";
import Pagination from "@/components/Pagination.astro";
import NoteCard from "@/components/NoteCard.astro";
import SearchInline from "@/components/SearchInline.astro";
import getSortedNotes from "@/utils/getSortedNotes";
import getUniqueNoteTags from "@/utils/getUniqueNoteTags";
import { slugifyStr } from "@/utils/slugify";
import getNoteSlug from "@/utils/getNoteSlug";
import { SITE } from "@/config";

export const getStaticPaths = (async ({ paginate }) => {
  const notes = await getCollection("notes");
  return paginate(getSortedNotes(notes), {
    pageSize: 6,
  });
}) satisfies GetStaticPaths;

const { page } = Astro.props;
const allNotes = await getCollection("notes");
const tags = getUniqueNoteTags(allNotes);
const topTagLimit = 5;
const moreTagsAvailable = tags.length > topTagLimit;
---

<Layout title={`Notes | ${SITE.title}`}>
  <Header />
  <Main pageTitle="Notes" pageDesc="Ideas, research, and short reflections.">
    <SearchInline id="notes-search" backUrl={Astro.url.pathname} />

    {tags.length > 0 && (
      <section class="section-unstyled mt-6 px-0" data-note-tags>
        <div class="flex flex-wrap gap-2 text-sm" data-tag-list>
          {tags.map((tag, index) => (
            <a
              href={`/notes/?tag=${tag.tag}`}
              class="group inline-flex items-center rounded-full border border-border/70 px-3 py-1 text-xs font-medium text-foreground/80 transition hover:border-accent hover:text-accent"
              hidden={index >= topTagLimit}
              data-note-tag
              data-tag={tag.tag}
              data-count={tag.count}
              data-tag-extra={index >= topTagLimit}
            >
              <span class="me-1 text-sm font-semibold text-accent">#</span>
              <span>{tag.tagName}</span>
              <span class="ms-1 rounded-full bg-muted px-2 py-0.5 text-[0.7rem] font-semibold text-foreground/70">
                {tag.count}
              </span>
            </a>
          ))}
        </div>
        {moreTagsAvailable && (
          <button
            type="button"
            class="mt-3 text-sm font-medium text-accent underline underline-offset-4 hover:text-accent/80"
            data-tags-toggle
          >
            Show more tags
          </button>
        )}
        <button
          type="button"
          class="mt-4 hidden text-sm font-medium text-accent underline underline-offset-4 hover:text-accent/80"
          data-tags-clear
        >
          Clear filter
        </button>
      </section>
    )}

    <section class="section-unstyled mt-8 px-0">
      <div data-note-grid>
        {page.data.length > 0 ? (
          <div class="grid gap-6 md:grid-cols-2">
            {page.data.map(note => <NoteCard note={note} />)}
          </div>
        ) : (
          <p class="text-muted">No notes published yet.</p>
        )}
      </div>
      <div class="hidden" data-filtered-grid aria-live="polite"></div>
    </section>
  </Main>

  <Pagination {page} data-pagination />

  <Footer noMarginTop={page.lastPage > 1} />
</Layout>

<div class="hidden" aria-hidden="true">
  {allNotes.map(note => (
    <template
      data-note-template
      data-slug={getNoteSlug(note)}
      data-tags={note.data.tags.map(tag => slugifyStr(tag)).join(" ")}
    >
      <NoteCard note={note} />
    </template>
  ))}
</div>

<script is:inline>
  function setupTagCloud() {
    const urlParams = new URLSearchParams(window.location.search);
    const tagButtons = Array.from(
      document.querySelectorAll("[data-note-tag]")
    ).filter(btn => btn instanceof HTMLElement);
    if (!tagButtons.length) return;

    const toggleBtn = document.querySelector("[data-tags-toggle]");
    const clearBtn = document.querySelector("[data-tags-clear]");
    const defaultGrid = document.querySelector("[data-note-grid]");
    const filteredGrid = document.querySelector("[data-filtered-grid]");
    const pagination = document.querySelector("[data-pagination]");
    const templates = Array.from(
      document.querySelectorAll("template[data-note-template]")
    ).filter(template => template instanceof HTMLTemplateElement);
    const templateData = templates.map(template => ({
      tags: (template.dataset.tags || "").split(" ").filter(Boolean),
      fragment: template.content,
    }));

    let showAllTags = false;
    let activeTag = null;

    const getExtraButtons = () =>
      tagButtons.filter(btn => btn.dataset.tagExtra === "true");

    toggleBtn?.addEventListener("click", event => {
      event.preventDefault();
      showAllTags = !showAllTags;
      getExtraButtons().forEach(btn =>
        btn.toggleAttribute("hidden", !showAllTags)
      );
      toggleBtn.textContent = showAllTags ? "Show fewer tags" : "Show more tags";
    });

    const updateActive = slug => {
      activeTag = slug;
      tagButtons.forEach(btn => {
        const isActive = btn.dataset.tag === slug;
        btn.classList.toggle("bg-accent/10", isActive);
        btn.classList.toggle("text-accent", isActive);
      });
    };

    const resetFiltering = () => {
      filteredGrid?.classList.add("hidden");
      if (filteredGrid) filteredGrid.innerHTML = "";
      defaultGrid?.classList.remove("hidden");
      pagination?.classList.remove("hidden");
      clearBtn?.classList.add("hidden");
      urlParams.delete("tag");
      history.replaceState(history.state, "", `${window.location.pathname}?${urlParams.toString()}`.replace(/\?$/, ""));
      updateActive(null);
    };

    const renderFiltered = slug => {
      if (!filteredGrid) return;
      const matches = templateData.filter(note => note.tags.includes(slug));
      filteredGrid.innerHTML = "";
      if (!matches.length) {
        filteredGrid.innerHTML =
          '<p class="mt-6 text-muted">No notes for this tag yet.</p>';
      } else {
        const wrapper = document.createElement("div");
        wrapper.className = "grid gap-6 md:grid-cols-2";
        matches.forEach(note => {
          wrapper.appendChild(
            note.fragment.cloneNode(true)
          );
        });
        filteredGrid.appendChild(wrapper);
      }
      filteredGrid.classList.remove("hidden");
      defaultGrid?.classList.add("hidden");
      pagination?.classList.add("hidden");
      clearBtn?.classList.remove("hidden");
    };

    tagButtons.forEach(btn => {
      btn.addEventListener("click", event => {
        event.preventDefault();
        const slug = btn.dataset.tag;
        if (!slug) return;

        if (activeTag === slug) {
          resetFiltering();
          return;
        }

        updateActive(slug);
        urlParams.set("tag", slug);
        history.replaceState(history.state, "", `${window.location.pathname}?${urlParams.toString()}`);
        renderFiltered(slug);
      });
    });

    clearBtn?.addEventListener("click", event => {
      event.preventDefault();
      resetFiltering();
    });

    const initialTag = urlParams.get("tag");
    if (initialTag) {
      const targetBtn = tagButtons.find(btn => btn.dataset.tag === initialTag);
      if (targetBtn && targetBtn.dataset.tagExtra === "true") {
        showAllTags = true;
        getExtraButtons().forEach(btn => btn.removeAttribute("hidden"));
        if (toggleBtn) toggleBtn.textContent = "Show fewer tags";
      }
      if (targetBtn) {
        updateActive(initialTag);
        renderFiltered(initialTag);
      }
    }
  }

  document.addEventListener("astro:after-swap", setupTagCloud);
  setupTagCloud();
</script>
