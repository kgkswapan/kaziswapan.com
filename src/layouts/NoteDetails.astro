---
import { render, type CollectionEntry, getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import BackButton from "@/components/BackButton.astro";
import BackToTopButton from "@/components/BackToTopButton.astro";
import Datetime from "@/components/Datetime.astro";
import LinkButton from "@/components/LinkButton.astro";
import { SITE } from "@/config";
import { slugifyStr } from "@/utils/slugify";
import noteFilter from "@/utils/noteFilter";
import getNoteSlug from "@/utils/getNoteSlug";
import getProjectSlug from "@/utils/getProjectSlug";

interface Props {
  note: CollectionEntry<"notes">;
  notes: CollectionEntry<"notes">[];
}

const { note, notes } = Astro.props;
const { title, summary, pubDatetime, tags, timezone } = note.data;

const { Content } = await render(note);

const layoutProps = {
  title: `${title} | ${SITE.title}`,
  description: summary,
  scrollSmooth: true,
};

const sortedNotes = notes.filter(noteFilter);
const currentIndex = sortedNotes.findIndex(item => item.id === note.id);
const prevNote = currentIndex > 0 ? sortedNotes[currentIndex - 1] : undefined;
const nextNote =
  currentIndex !== -1 && currentIndex + 1 < sortedNotes.length
    ? sortedNotes[currentIndex + 1]
    : undefined;

const noteSlug = getNoteSlug(note);
const getHref = (noteEntry: CollectionEntry<"notes">) =>
  `/notes/${getNoteSlug(noteEntry)}/`;

const projects = await getCollection("projects");
const lowerTags = tags.map(tag => tag.toLowerCase());
const relatedProject = projects.find(project => {
  const projectTag = project.data.noteTag;
  return (
    typeof projectTag === "string" &&
    lowerTags.includes(projectTag.toLowerCase())
  );
});
const relatedProjectHref = relatedProject
  ? `/projects/${getProjectSlug(relatedProject)}/`
  : undefined;

const books = await getCollection("books");
const relatedBook = books.find(book => {
  if (book.id.startsWith("archived/")) return false;
  return book.data.noteSlug && book.data.noteSlug === noteSlug;
});
const affiliateLink =
  typeof relatedBook?.data.affiliateLink === "string"
    ? relatedBook.data.affiliateLink
    : "";
---

<Layout {...layoutProps}>
  <Header />
  <BackButton />
  <main
    id="main-content"
    class="mx-auto w-full max-w-app px-4 pb-12"
    data-pagefind-body
  >
    <h1 class="inline-block text-2xl font-bold text-accent sm:text-3xl">
      {title}
    </h1>
    <div class="my-2">
      <Datetime {pubDatetime} {timezone} size="lg" />
    </div>

    <article
      id="article"
      class="app-prose mx-auto mt-8 max-w-app prose-pre:bg-(--shiki-light-bg) dark:prose-pre:bg-(--shiki-dark-bg)"
    >
      <Content />
    </article>
    {
      affiliateLink && (
        <div class="mt-8">
          <LinkButton
            class="inline-flex items-center gap-2 rounded-full border border-accent/70 px-4 py-2 text-sm font-semibold text-accent transition hover:-translate-y-0.5 hover:border-accent"
            href={affiliateLink}
            target="_blank"
          >
            Buy on Amazon
          </LinkButton>
        </div>
      )
    }
    {
      relatedProject && relatedProjectHref && (
        <section class="bg-surface/40 mt-10 rounded-2xl border border-muted/60 p-6">
          <p class="text-xs tracking-wide text-foreground/70 uppercase">
            Part of project
          </p>
          <h2 class="mt-1 text-lg font-semibold text-foreground">
            {relatedProject.data.title}
          </h2>
          <p class="mt-2 text-sm text-foreground/80">
            {relatedProject.data.summary}
          </p>
          <a
            class="mt-4 inline-flex items-center gap-2 rounded-full border border-accent/70 px-4 py-2 text-sm font-semibold text-accent transition hover:-translate-y-0.5 hover:border-accent"
            href={relatedProjectHref}
          >
            View project
            <span aria-hidden="true">â†’</span>
          </a>
        </section>
      )
    }

    <ul class="mt-6 flex flex-wrap gap-2 text-xs font-medium">
      {
        tags.map(tag => {
          const tagSlug = slugifyStr(tag);
          return (
            <li>
              <a
                href={`/notes/?tag=${tagSlug}`}
                class="inline-flex items-center rounded-full border border-border/70 px-3 py-1 text-foreground/80 transition hover:border-accent hover:text-accent"
              >
                <span class="me-1 text-sm font-semibold text-accent">#</span>
                {tag}
              </a>
            </li>
          );
        })
      }
    </ul>

    <BackToTopButton />

    {
      (prevNote || nextNote) && (
        <div
          data-pagefind-ignore
          class="mt-10 grid grid-cols-1 gap-6 border-t border-dashed pt-6 text-sm sm:grid-cols-2"
        >
          {prevNote && (
            <a
              href={getHref(prevNote)}
              class="group flex w-full items-center gap-2 rounded-xl border border-border/70 px-4 py-3 transition hover:-translate-y-0.5 hover:border-accent hover:text-accent"
            >
              <span class="text-xs tracking-wide text-accent uppercase">
                Previous
              </span>
              <span class="font-medium">{prevNote.data.title}</span>
            </a>
          )}
          {nextNote && (
            <a
              href={getHref(nextNote)}
              class="group flex w-full items-center justify-end gap-2 rounded-xl border border-border/70 px-4 py-3 text-end transition hover:-translate-y-0.5 hover:border-accent hover:text-accent sm:col-start-2"
            >
              <span class="text-xs tracking-wide text-accent uppercase">
                Next
              </span>
              <span class="font-medium">{nextNote.data.title}</span>
            </a>
          )}
        </div>
      )
    }
  </main>
  <Footer />
</Layout>
